!function(window){let treeTableInstanceCount=0;const DEFAULTS={tableSelectorId:"treeTable",searchContainerId:null,showToggleAllButton:!0,highlightSearchMatches:!0,searchHighlightColor:"#ffff8b",searchMaxLevel:null,classes:{searchInput:"pe-5",searchWrapper:"mb-3 position-relative",searchWrapperStyle:"max-width:400px;",resetBtn:"btn-sm position-absolute top-50 end-0 translate-middle-y me-2 d-none",noResults:"alert alert-warning small d-none mt-2",toggleBtn:"btn-primary",toggleAllBtn:"btn-outline-secondary"},iconClasses:{toggleRow:"fa-solid fa-chevron-right fa-fw rotate-icon",toggleAllOpen:"fa-solid fa-plus",toggleAllClose:"fa-solid fa-minus",reset:"fa-solid fa-xmark"},i18n:{searchPlaceholder:"In allen Ebenen suchen...",searchResetAria:"ZurÃ¼cksetzen",toggleAllBtnTitle:"Alle ein-/ausklappen",noResults:"Keine Ergebnisse gefunden"}};function mergeOptions(defaults,options){const out={...defaults};for(const key in options)"object"!=typeof options[key]||null===options[key]||Array.isArray(options[key])?out[key]=options[key]:out[key]=mergeOptions(defaults[key]||{},options[key]);return out}function init(userOptions={}){const options=mergeOptions(DEFAULTS,userOptions);let tableSelector=options.tableSelectorId.startsWith("#")?options.tableSelectorId:"#"+options.tableSelectorId;const table=document.querySelector(tableSelector);if(!table)return;const instanceId=++treeTableInstanceCount,rows=Array.from(table.querySelectorAll("tr"));function getLevel(tr){const match=Array.from(tr.classList).find(c=>c.startsWith("level-"));return match?parseInt(match.replace("level-",""),10):0}function hasChild(tr,idx){const thisLevel=getLevel(tr),next=rows[idx+1];return!!(next&&getLevel(next)>thisLevel)}function isDataRow(tr){return tr.closest("tbody")&&Array.from(tr.classList).some(c=>c.startsWith("level-"))}let toggleAllBtn=null,searchInput,resetBtn;if(options.showToggleAllButton){const th=table.querySelector("thead tr th");if(th&&!th.querySelector("#toggleAll"+instanceId)){const btn=document.createElement("button");btn.id="toggleAll"+instanceId,btn.className="btn "+(options.classes.toggleAllBtn||""),btn.title=options.i18n.toggleAllBtnTitle,btn.innerHTML=`<i id="toggleAllIcon${instanceId}" class="${options.iconClasses.toggleAllOpen}"></i>`,th.appendChild(btn)}toggleAllBtn=document.getElementById("toggleAll"+instanceId)}const tableSearchId="tableSearch"+instanceId,resetSearchId="resetSearch"+instanceId;let searchContainerId=options.searchContainerId?options.searchContainerId.startsWith("#")?options.searchContainerId.slice(1):options.searchContainerId:null;if(searchContainerId&&document.getElementById(searchContainerId)){if(!document.getElementById(tableSearchId)){const searchDiv=document.createElement("div");searchDiv.className="position-relative "+(options.classes.searchWrapper||""),searchDiv.style.cssText=options.classes.searchWrapperStyle||"",searchDiv.innerHTML=`\n          <input type="text" id="${tableSearchId}" class="form-control ${options.classes.searchInput||""}" placeholder="${options.i18n.searchPlaceholder}"/>\n          <button id="${resetSearchId}" type="button" class="btn ${options.classes.resetBtn||""}" style="z-index:2" aria-label="${options.i18n.searchResetAria}">\n            <i class="${options.iconClasses.reset}"></i>\n          </button>\n        `,document.getElementById(searchContainerId).appendChild(searchDiv)}searchInput=document.getElementById(tableSearchId),resetBtn=document.getElementById(resetSearchId)}const tableSearchEmptyId="tableSearchEmpty"+instanceId;if(!document.getElementById(tableSearchEmptyId)){const emptyDiv=document.createElement("div");emptyDiv.id=tableSearchEmptyId,emptyDiv.className="table-search-empty "+(options.classes.noResults||""),emptyDiv.textContent=options.i18n.noResults,table.after(emptyDiv)}const searchEmptyMsg=document.getElementById(tableSearchEmptyId);function ensureToggleButtons(){rows.forEach((tr,idx)=>{isDataRow(tr)&&hasChild(tr,idx)&&!tr.querySelector(".toggle-btn")&&(tr.children[0].innerHTML=`\n            <button class="btn toggle-btn ${options.classes.toggleBtn||""}" data-open="false">\n              <i class="${options.iconClasses.toggleRow}"></i>\n            </button>\n          `)})}function attachToggleBtnListeners(){table.querySelectorAll(".toggle-btn").forEach(btn=>{btn.hasAttribute("data-init")||(btn.setAttribute("data-init","1"),btn.addEventListener("click",(function(){const tr=btn.closest("tr"),open="true"!==btn.getAttribute("data-open");setBranch(tr,open),ensureToggleButtons(),attachToggleBtnListeners(),updateAllToggleButtonStates(),updateToggleAllIcon()})))})}function setBranch(tr,open){const thisLevel=getLevel(tr);let reached=!1;for(const row of rows)if(row!==tr){if(reached){if(!isDataRow(row))continue;const rowLevel=getLevel(row);if(rowLevel<=thisLevel)break;if(open)rowLevel===thisLevel+1&&(row.style.display="");else{row.style.display="none";const btnInRow=row.querySelector(".toggle-btn");btnInRow&&(btnInRow.setAttribute("data-open","false"),btnInRow.classList.remove("open"))}}}else reached=!0;const btn=tr.querySelector(".toggle-btn");btn&&(btn.setAttribute("data-open",open?"true":"false"),btn.classList.toggle("open",open)),updateAllToggleButtonStates()}function isAnyChildRowVisible(){return rows.some(tr=>isDataRow(tr)&&"none"!==tr.style.display&&getLevel(tr)>0)}function updateToggleAllIcon(){const toggleAllIcon=document.getElementById("toggleAllIcon"+instanceId);toggleAllIcon&&(toggleAllIcon.className=isAnyChildRowVisible()?options.iconClasses.toggleAllClose:options.iconClasses.toggleAllOpen)}function updateAllToggleButtonStates(){rows.forEach((tr,idx)=>{if(!isDataRow(tr))return;const btn=tr.querySelector(".toggle-btn");if(!btn)return;const thisLevel=getLevel(tr);let hasVisibleChild=!1;for(let j=idx+1;j<rows.length;j++){const nextTr=rows[j];if(!isDataRow(nextTr))continue;const nextLevel=getLevel(nextTr);if(nextLevel<=thisLevel)break;if(nextLevel===thisLevel+1&&"none"!==nextTr.style.display){hasVisibleChild=!0;break}}btn.setAttribute("data-open",hasVisibleChild?"true":"false"),btn.classList.toggle("open",hasVisibleChild)})}function resetHighlight(){rows.forEach(tr=>{isDataRow(tr)&&Array.from(tr.cells).forEach(td=>{td.innerHTML=td.textContent})})}function showParentChain(tr){let thisLevel=getLevel(tr),idx;for(let i=rows.indexOf(tr)-1;i>=0;i--){let tr2=rows[i];if(!isDataRow(tr2))continue;let lvl=getLevel(tr2);if(lvl<thisLevel){tr2.style.display="";let btn=tr2.querySelector(".toggle-btn");btn&&(btn.setAttribute("data-open","true"),btn.classList.add("open")),thisLevel=lvl}if(0===lvl)break}}function performSearch(val){resetHighlight();const maxLevel="number"==typeof options.searchMaxLevel?options.searchMaxLevel:null;if(!val.trim())return rows.forEach(tr=>{if(isDataRow(tr)){tr.style.display=getLevel(tr)>0?"none":"";let btn=tr.querySelector(".toggle-btn");btn&&(btn.setAttribute("data-open","false"),btn.classList.remove("open"))}}),ensureToggleButtons(),attachToggleBtnListeners(),updateAllToggleButtonStates(),updateToggleAllIcon(),resetBtn&&resetBtn.classList.add("d-none"),void(searchEmptyMsg&&searchEmptyMsg.classList.add("d-none"));let foundRows=[];rows.forEach(tr=>{if(!isDataRow(tr))return;const lvl=getLevel(tr);if(null!==maxLevel&&lvl>maxLevel)return void(tr.style.display="none");let hit=!1;Array.from(tr.cells).forEach(td=>{const text=td.textContent.trim(),idx=text.toLowerCase().indexOf(val.toLowerCase());idx>=0&&(options.highlightSearchMatches&&(td.innerHTML=text.substring(0,idx)+`<mark style="background:${options.searchHighlightColor};padding:0 2px;border-radius:2px">${text.substring(idx,idx+val.length)}</mark>`+text.substring(idx+val.length)),hit=!0)}),tr.style.display=hit?"":"none",hit&&foundRows.push(tr)}),foundRows.forEach(tr=>showParentChain(tr)),ensureToggleButtons(),attachToggleBtnListeners(),updateAllToggleButtonStates(),updateToggleAllIcon();let hasVisibleRow=rows.some(tr=>isDataRow(tr)&&"none"!==tr.style.display);searchEmptyMsg&&(!hasVisibleRow&&searchInput&&""!==searchInput.value.trim()?searchEmptyMsg.classList.remove("d-none"):searchEmptyMsg.classList.add("d-none")),resetBtn&&resetBtn.classList.remove("d-none")}toggleAllBtn&&toggleAllBtn.addEventListener("click",(function(){searchInput&&""!==searchInput.value&&(searchInput.value="",performSearch(""));const anyVisible=isAnyChildRowVisible();rows.forEach(tr=>{if(isDataRow(tr)&&getLevel(tr)>0){tr.style.display=anyVisible?"none":"";const btn=tr.querySelector(".toggle-btn");btn&&(btn.setAttribute("data-open",anyVisible?"false":"true"),btn.classList.toggle("open",!anyVisible))}}),ensureToggleButtons(),attachToggleBtnListeners(),updateAllToggleButtonStates(),updateToggleAllIcon()})),rows.forEach(tr=>{if(isDataRow(tr)){tr.style.display=getLevel(tr)>0?"none":"";const btn=tr.querySelector(".toggle-btn");btn&&(btn.setAttribute("data-open","false"),btn.classList.remove("open"))}}),ensureToggleButtons(),attachToggleBtnListeners(),updateAllToggleButtonStates(),updateToggleAllIcon(),searchInput&&(searchInput.addEventListener("input",(function(){performSearch(searchInput.value)})),resetBtn.addEventListener("click",(function(){searchInput.value="",performSearch("")})),searchInput.addEventListener("keydown",(function(e){"Escape"===e.key&&(searchInput.value="",performSearch(""))})))}window.BootstrapTreeTable={init:init}}(window);