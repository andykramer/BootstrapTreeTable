class BootstrapTreeTable{static DEFAULTS={tableSelectorId:"treeTable",searchContainerId:null,showToggleAllButton:!0,highlightSearchMatches:!0,searchHighlightColor:"#ffff8b",searchMaxLevel:null,toggleColumnIndex:0,startExpanded:!1,rememberState:!1,restorePreSearchStateOnClear:!1,classes:{searchInput:"pe-5",searchWrapper:"mb-3 position-relative",searchWrapperStyle:"max-width:400px;",resetBtn:"btn-sm position-absolute top-50 end-0 translate-middle-y me-2 d-none",noResults:"alert alert-warning small d-none mt-2",toggleRowBtn:"btn-primary btn-sm",toggleAllBtn:"btn-outline-secondary btn-sm"},iconClasses:{toggleRowOpen:"fa-solid fa-chevron-up fa-fw",toggleRowClose:"fa-solid fa-chevron-down fa-fw",toggleAllOpen:"fa-solid fa-plus fa-fw",toggleAllClose:"fa-solid fa-minus fa-fw",reset:"fa-solid fa-xmark"},i18n:{searchPlaceholder:"Search all levels...",searchResetAria:"Reset",toggleAllBtnTitle:"Expand/collapse all",noResults:"No results found"}};constructor(t,e={}){if(this.options=this._mergeOptions(BootstrapTreeTable.DEFAULTS,e),this.table=this._resolveTable(t),this.table){if(this.table.id)this.storageKey=`btt-state:${this.table.id}`;else{const t=Array.from(document.querySelectorAll("table")).indexOf(this.table);this.storageKey=`btt-state:table-${t}`}this.rows=Array.from(this.table.querySelectorAll("tr")),this.searchInput=null,this.resetBtn=null,this.noResultsDiv=null,this.toggleAllBtn=null,this._preSearchSnapshot=null,this._hadSnapshotThisSearch=!1,this._init()}}_init(){this._cacheCellHtml(),this._initVisibility(),this._ensureToggleButtons(),this._setupSearchUI(),this._setupToggleAllBtn(),this._restoreState()||(this._updateAllToggleButtonStates(),this._updateToggleAllBtnIcon()),this._setupRowClickHandler()}_mergeOptions(t,e){const s={...t};for(const i in e||{})"object"!=typeof e[i]||null===e[i]||Array.isArray(e[i])?s[i]=e[i]:s[i]=this._mergeOptions(t[i]||{},e[i]);return s}_resolveTable(t){return"string"==typeof t?document.querySelector(t.startsWith("#")?t:`#${t}`):t instanceof HTMLElement?t:null}_getLevel(t){const e=Array.from(t.classList).find((t=>t.startsWith("level-")));return e?parseInt(e.replace("level-",""),10):0}_isDataRow(t){return t.closest("tbody")&&Array.from(t.classList).some((t=>t.startsWith("level-")))}_setVisible(t,e){t.dataset.visible=e?"true":"false",t.style.display=e?"":"none"}_cacheCellHtml(){this.rows.forEach((t=>{this._isDataRow(t)&&Array.from(t.cells).forEach((t=>{if(!t.querySelector(".btt-content")){const e=document.createElement("span");for(e.className="btt-content";t.firstChild;)e.appendChild(t.firstChild);t.appendChild(e)}const e=t.querySelector(".btt-content");e&&!e.hasAttribute("data-orig-html")&&e.setAttribute("data-orig-html",e.innerHTML)}))}))}_restoreCellHtml(t){Array.from(t.cells).forEach((t=>{const e=t.querySelector(".btt-content");if(!e)return;const s=e.getAttribute("data-orig-html");null!==s&&(e.innerHTML=s)}))}_initVisibility(){this.rows.forEach((t=>{if(!this._isDataRow(t))return;const e=0===this._getLevel(t),s=this.options.startExpanded||e;this._setVisible(t,s)}))}_ensureToggleButtons(){this.rows.forEach(((t,e)=>{if(!this._isDataRow(t))return;Array.from(t.cells).forEach((t=>{if(!t.querySelector(".btt-content")){const e=document.createElement("span");for(e.className="btt-content";t.firstChild;)e.appendChild(t.firstChild);t.appendChild(e)}const e=t.querySelector(".btt-content");e&&!e.hasAttribute("data-orig-html")&&e.setAttribute("data-orig-html",e.innerHTML)}));const s=this._getLevel(t),i=this.rows[e+1];if(!(i&&this._getLevel(i)>s))return;const o=t.cells[this.options.toggleColumnIndex]||t.cells[0];if(!o||o.querySelector(".toggle-row-btn"))return;const l=document.createElement("button");l.type="button",l.className="btn toggle-row-btn "+(this.options.classes.toggleRowBtn||""),l.setAttribute("data-open","false"),l.setAttribute("aria-expanded","false"),l.setAttribute("aria-label","Toggle row"),l.innerHTML=`<i class="${this.options.iconClasses.toggleRowClose}"></i>`;const n=o.querySelector(".btt-content");o.insertBefore(l,n),o.style.whiteSpace="nowrap",o.classList.add("btt-cell")}))}_isAnyChildRowVisible(){return this.rows.some((t=>this._isDataRow(t)&&this._getLevel(t)>0&&"true"===t.dataset.visible))}_updateToggleAllBtnIcon(){if(!this.toggleAllBtn)return;const t=this._isAnyChildRowVisible()?this.options.iconClasses.toggleAllClose:this.options.iconClasses.toggleAllOpen;this.toggleAllBtn.innerHTML=`<i class="${t}"></i>`}_updateRowToggleIcon(t,e){if(!t)return;const s=e?this.options.iconClasses.toggleRowOpen:this.options.iconClasses.toggleRowClose;t.innerHTML=`<i class="${s}"></i>`}_updateAllToggleButtonStates(){this.rows.forEach(((t,e)=>{if(!this._isDataRow(t))return;const s=t.querySelector(".toggle-row-btn");if(!s)return;const i=this._getLevel(t);let o=!1;for(let t=e+1;t<this.rows.length;t++){const e=this.rows[t];if(!this._isDataRow(e))continue;const s=this._getLevel(e);if(s<=i)break;if(s===i+1&&"true"===e.dataset.visible){o=!0;break}}s.setAttribute("data-open",o?"true":"false"),s.classList.toggle("open",o),s.setAttribute("aria-expanded",o?"true":"false"),this._updateRowToggleIcon(s,o)}))}_setBranch(t,e){const s=this._getLevel(t);let i=!1;for(const o of this.rows){if(o===t){i=!0;continue}if(!i||!this._isDataRow(o))continue;const l=this._getLevel(o);if(l<=s)break;if(e)l===s+1&&this._setVisible(o,!0);else{this._setVisible(o,!1);const t=o.querySelector(".toggle-row-btn");t&&(t.setAttribute("data-open","false"),t.classList.remove("open"),t.setAttribute("aria-expanded","false"),this._updateRowToggleIcon(t,!1))}}const o=t.querySelector(".toggle-row-btn");o&&(o.setAttribute("data-open",e?"true":"false"),o.classList.toggle("open",e),o.setAttribute("aria-expanded",e?"true":"false"),this._updateRowToggleIcon(o,e)),this._updateAllToggleButtonStates(),this._updateToggleAllBtnIcon(),this._persistState()}_setupSearchUI(){if(!this.options.searchContainerId)return;const t=document.getElementById(this.options.searchContainerId);if(!t)return;const e=document.createElement("div");e.className=this.options.classes.searchWrapper,e.style=this.options.classes.searchWrapperStyle;const s=document.createElement("input");s.type="text",s.className="form-control "+(this.options.classes.searchInput||""),s.placeholder=this.options.i18n.searchPlaceholder,s.setAttribute("aria-label",this.options.i18n.searchPlaceholder),e.appendChild(s);const i=document.createElement("button");i.type="button",i.className="btn "+this.options.classes.resetBtn,i.setAttribute("aria-label",this.options.i18n.searchResetAria),i.innerHTML=`<i class="${this.options.iconClasses.reset}"></i>`,e.appendChild(i);const o=document.createElement("div");o.className="table-search-empty "+(this.options.classes.noResults||""),o.textContent=this.options.i18n.noResults,t.appendChild(e),t.appendChild(o),this.searchInput=s,this.resetBtn=i,this.noResultsDiv=o,s.addEventListener("input",(()=>{const t=s.value.trim().toLowerCase();this._performSearch(t)})),s.addEventListener("keydown",(t=>{"Escape"===t.key&&(s.value="",this._performSearch(""),i.classList.add("d-none"),o.classList.add("d-none"))})),i.addEventListener("click",(()=>{s.value="",this._performSearch(""),i.classList.add("d-none"),o.classList.add("d-none")}))}_performSearch(t){let e=0;if(!t)return this.options.restorePreSearchStateOnClear&&this._preSearchSnapshot?(this._applyState(this._preSearchSnapshot),this._preSearchSnapshot=null):(this._initVisibility(),this._ensureToggleButtons(),this._updateAllToggleButtonStates(),this._updateToggleAllBtnIcon()),this.noResultsDiv.classList.add("d-none"),void this.resetBtn.classList.add("d-none");this._hadSnapshotThisSearch||(this._preSearchSnapshot=this._collectState(),this._hadSnapshotThisSearch=!0),this.rows.forEach((s=>{if(!this._isDataRow(s))return;if(this._restoreCellHtml(s),!t)return void this._setVisible(s,0===this._getLevel(s));s.innerText.toLowerCase().includes(t)?(e++,this._setVisible(s,!0),this.options.highlightSearchMatches&&Array.from(s.cells).forEach((e=>{const s=e.querySelector(".btt-content");if(!s)return;const i=s.getAttribute("data-orig-html")??s.innerHTML,o=new RegExp(`(${t})`,"gi");s.innerHTML=i.replace(o,`<span style="background:${this.options.searchHighlightColor}">$1</span>`)}))):this._setVisible(s,!1)})),this._ensureToggleButtons(),this.resetBtn.classList.toggle("d-none",!t),this.noResultsDiv.classList.toggle("d-none",e>0),this._updateAllToggleButtonStates(),this._updateToggleAllBtnIcon()}_setupToggleAllBtn(){if(!this.options.showToggleAllButton)return;const t=this.table.querySelector("thead tr th");if(!t)return;const e=document.createElement("button");e.type="button",e.className="btn "+(this.options.classes.toggleAllBtn||""),e.title=this.options.i18n.toggleAllBtnTitle,e.innerHTML=`<i class="${this.options.iconClasses.toggleAllOpen}"></i>`,t.appendChild(e),this.toggleAllBtn=e,e.addEventListener("click",(()=>{this._isAnyChildRowVisible()?this.rows.forEach((t=>{this._isDataRow(t)&&this._getLevel(t)>0&&this._setVisible(t,!1)})):this.rows.forEach((t=>{this._isDataRow(t)&&this._setVisible(t,!0)})),this._updateAllToggleButtonStates(),this._updateToggleAllBtnIcon(),this._persistState()}))}_setupRowClickHandler(){this.table.addEventListener("click",(t=>{const e=t.target.closest(".toggle-row-btn");if(!e)return;const s=e.closest("tr"),i="true"===e.getAttribute("data-open");this._setBranch(s,!i)}))}_collectState(){return this.rows.map((t=>({visible:"true"===t.dataset.visible})))}_applyState(t){Array.isArray(t)&&t.length===this.rows.length&&(t.forEach(((t,e)=>{const s=this.rows[e];this._isDataRow(s)&&this._setVisible(s,t.visible)})),this._ensureToggleButtons(),this._updateAllToggleButtonStates(),this._updateToggleAllBtnIcon())}_persistState(){if(this.options.rememberState)try{const t=this._collectState();localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(t){}}_restoreState(){if(!this.options.rememberState)return!1;try{const t=localStorage.getItem(this.storageKey);if(!t)return!1;const e=JSON.parse(t);return this._applyState(e),!0}catch(t){return!1}}}